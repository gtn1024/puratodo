# PuraToDo Development Progress

## Project Overview
A modern todo application built with Next.js 16+, Supabase, and Tailwind CSS.
Supports groups, lists, and infinitely nested tasks.

## Tech Stack
- Frontend: Next.js 16+ (App Router) + TypeScript + Tailwind CSS v4 + shadcn/ui
- Backend: Supabase (PostgreSQL + Auth + Realtime + RLS)
- Testing: Playwright MCP (E2E)

## Data Model

```
users (Supabase Auth)
    └── groups (1:N)
            └── lists (1:N)
                    └── tasks (1:N, self-referencing for subtasks)
```

All tables include user_id for RLS policies and query optimization.

---

### 2026-02-20

#### 完成
- Monorepo Phase 1: Monorepo Setup (完成)
  - Feature #1: 创建 monorepo 根配置文件
    - pnpm-workspace.yaml (apps/*, packages/*)
    - 根 package.json (puratodo-monorepo, pnpm scripts)
    - .npmrc (auto-install-peers=true)
    - tsconfig.base.json (共享 TypeScript 配置)
    - 更新 .gitignore (支持 monorepo 结构)
  - Feature #2: 创建 apps 目录并迁移 web 项目
    - 创建 apps/web/ 目录
    - 移动所有文件到 apps/web/ (src/, public/, supabase/, 配置文件)
    - 更新 apps/web/package.json name 为 @puratodo/web
    - 添加 workspace 依赖: @puratodo/ui, @puratodo/api-types, @puratodo/shared
    - 更新 apps/web/tsconfig.json 继承 tsconfig.base.json
  - Feature #3: 创建 packages 目录和共享包结构
    - packages/ui/ - UI 组件库 (@puratodo/ui)
    - packages/api-types/ - API 类型定义 (@puratodo/api-types)
    - packages/shared/ - 共享工具函数 (@puratodo/shared)
    - 每个包包含 package.json, tsconfig.json, src/index.ts
  - Feature #4: 安装并验证 pnpm workspaces
    - 删除旧的 npm 依赖 (node_modules, package-lock.json)
    - 运行 pnpm install 安装 monorepo 依赖
    - 验证 workspace 链接正确 (link:../../packages/*)
    - 构建验证通过: pnpm build:web
  - Feature #5: 添加 Vercel 部署配置
    - 创建 apps/web/vercel.json
    - 更新 CLAUDE.md 文档反映 monorepo 结构

#### 下一步
- Phase 2: Extract @puratodo/ui - 将 UI 组件迁移到共享包
- Phase 3: Extract @puratodo/api-types - 迁移 API 类型定义
- Phase 4: Extract @puratodo/shared - 迁移共享工具函数

---

### 2026-02-20 (Earlier)

#### 完成
- Feature #71: 日历视图（Calendar View）
  - 添加 `showCalendarView` 状态到 `dashboard-content.tsx`，与其他视图状态互斥
  - 在 Sidebar 添加 "日历/Calendar" 入口（紫色高亮）
  - 创建 `src/components/dashboard/calendar-panel.tsx` 日历面板组件：
    - 月视图 7 列网格（Sun-Sat）
    - 上/下月导航和 "今天" 快捷按钮
    - 日期格子显示任务预览（最多3个，显示 "+X more"）
    - 列表筛选下拉（所有列表/指定列表）
    - 右侧 "未安排" 任务侧边栏（桌面端可见）
  - 添加 `src/actions/tasks.ts` 查询函数：
    - `getTasksInDateRange`：按日期范围获取任务
    - `getUnscheduledTasks`：获取无 plan_date 的任务
  - 中英文翻译：添加 `calendar.*` 翻译键（title/month/week/today/unscheduled/noTasks/allLists）
  - Header 显示 "Calendar" 标题和紫色图标
  - 构建验证通过：`npm run build`
  - Playwright 测试验证：
    - 点击 "日历" 按钮切换到日历视图
    - 月份导航正常工作
    - 日历网格正确渲染
    - 列表筛选下拉正常工作
  - 说明：拖拽功能暂时未实现（保留 @dnd-kit 上下文供后续扩展）
- Feature #70: 批量操作（多选任务管理）
  - TaskPanel 新增多选模式：点击 "Select" 按钮进入选择模式
  - 每行任务显示选择框（Square/CheckSquare 图标）
  - 批量操作栏显示已选任务数量和操作按钮：
    - 全选/取消全选
    - 批量完成/未完成
    - 批量星标/取消星标
    - 批量删除（带确认对话框）
    - 批量设置截止日期（日期选择器）
  - 添加 `bulkUpdateTasks` 和 `bulkDeleteTasks` Server Actions
  - 支持乐观更新：本地状态立即更新，后台同步服务器
  - 中英文翻译：添加 `taskPanel.select/selected/selectAll/deselect/complete/incomplete/star/unstar/delete/setDate/cancel/tasksSelected`
  - 构建验证通过：`npm run build`
- Feature #69 (Step 1): 添加 reminder 字段到数据库
  - 创建迁移文件 `supabase/migrations/20260220000001_add_reminder_fields.sql`
  - 添加字段：`remind_at` (timestamptz), `reminder_sent_at` (timestamptz)
  - 添加索引：`idx_tasks_remind_at_pending`, `idx_tasks_remind_at_completed`
  - 更新 `database.types.ts` 中的类型定义
  - 更新 `src/actions/tasks.ts` 中的 Task 类型和 TaskUpdatePayload
- Feature #69 (Step 2): 浏览器通知权限流程
  - 创建 `src/lib/notifications.ts`：通知权限检查、请求、显示、调度工具函数
  - 支持 `scheduleNotification`, `scheduleTaskReminder`, `clearScheduledNotification` 等 API
  - 创建 `src/hooks/use-reminders.ts`：React hook 管理提醒调度
- Feature #69 (Step 4): 提醒设置 UI
  - 创建 `src/components/dashboard/reminder-fields.tsx`：提醒设置组件
  - 支持预设提醒（到期时、5分钟前、15分钟前、30分钟前、1小时前、1天前）
  - 支持自定义提醒时间
  - 集成到 `task-detail-panel.tsx` 和 `task-detail-sheet.tsx`
  - 创建 `src/components/dashboard/reminder-scheduler.tsx`：后台提醒调度组件
  - 集成到 `dashboard-content.tsx`
- Feature #69 (API): 更新 REST API 支持提醒字段
  - 更新 `src/app/api/v1/tasks/route.ts`：Task 类型添加 remind_at
  - 更新 `src/app/api/v1/tasks/[id]/route.ts`：PATCH 支持 remind_at
  - 更新 `src/app/api/openapi/route.ts`：OpenAPI 文档添加 remind_at/reminder_sent_at
- 中英文翻译：添加 `reminder.*` 翻译键
- 构建验证通过：`npm run build`
- 说明：
  - 数据库迁移需要手动在 Supabase 控制台运行或使用 `supabase db push`
  - 浏览器通知需要用户授权
  - 目前使用客户端定时器实现提醒，服务端推送通知可后续扩展

#### 下一步
- Feature #72: Natural language task creation with date and intent parsing
- Feature #73: Auto-generate weekly/monthly review reports from completed work

---

### 2026-02-20 (Earlier)

#### 完成
- Feature #68 (Step 1): Smart Views 入口与 Dashboard 视图状态
  - `Sidebar` 新增 Smart Views 分区与四个入口：`Starred / Overdue / Next 7 Days / No Date`
  - `DashboardContent` 新增 `selectedSmartView` 视图状态，并与 Today/Inbox/Group/List 切换互斥
  - 在切换 Group/List/Today/Inbox/Search 跳转时，统一清空 Smart View 状态，避免状态串扰
  - 主区域与顶部标题接入 Smart View 路由状态（当前为占位面板）
  - 新增中英文文案：
    - `sidebar.smartViews`
    - `sidebar.starred`
    - `sidebar.overdue`
    - `sidebar.next7Days`
    - `sidebar.noDate`
  - 构建验证通过：`npm run build`
  - 说明：Smart View 的数据查询与实时刷新将在 Feature #68 后续步骤实现
- Feature #68 (Step 2): 实现 Smart View 查询层（含索引优化）
  - `src/actions/tasks.ts` 新增 Smart View 查询 action：
    - `getStarredTasks`
    - `getOverdueTasks`
    - `getNext7DaysTasks`
    - `getNoDateTasks`
  - 查询策略：
    - Starred：`user_id + parent_id is null + starred=true`
    - Overdue：`user_id + parent_id is null + completed=false + due_date < today`
    - Next 7 Days：`user_id + parent_id is null + completed=false + due_date between today and today+7`
    - No Date：`user_id + parent_id is null + completed=false + due_date is null + plan_date is null`
  - 抽取公共上下文拼装：`attachTaskContext`，统一补齐 `list_name/list_icon/group_name/group_color`
  - `searchTasks` 与 `getTodayTasks` 改为复用公共上下文拼装逻辑，去除重复代码
  - `supabase/schema.sql` 新增 Smart View 相关 partial indexes：
    - `idx_tasks_starred_top_level`
    - `idx_tasks_due_date_open_top_level`
    - `idx_tasks_nodate_open_top_level`
  - 构建验证通过：`npm run build`
- Feature #68 (Step 3): 复用任务面板渲染 Smart Views + 上下文标签
  - `TaskPanel` 新增 `smartView` 模式，支持直接加载并展示：
    - `Starred / Overdue / Next 7 Days / No Date`
  - `DashboardContent` 中 Smart View 分支由占位卡片改为复用 `TaskPanel`
  - `TaskPanel` 头部可根据 Smart View 自动切换标题/图标/空状态文案
  - Smart View 模式下复用任务操作（完成、星标、编辑、删除、详情打开）
  - Smart View 模式下禁用不适用能力（新建任务、子任务新增、拖拽排序、Inbox move）
  - 在任务行新增跨列表上下文标签（列表图标+列表名+分组色点+分组名），满足 Smart View 可追溯性
  - 构建验证通过：`npm run build`
- Feature #68 (Step 4): Smart Views 实时刷新订阅
  - `TaskPanel` 的 realtime 订阅扩展到 Smart View 模式：不再仅限选中 list
  - 在 Smart View 模式订阅 `tasks` 变更（INSERT/UPDATE/DELETE）后自动 `reloadTasks`
  - 新增 Smart View 下 `lists/groups` 变更订阅，用于列表名/分组名/颜色变化时自动刷新上下文标签
  - 为日期驱动视图（`Overdue` / `Next 7 Days`）新增本地午夜自动刷新定时器，避免跨天无变更时视图滞后
  - 任务过滤中的“今天”判断改为本地日期字符串（替代 UTC `toISOString`），减少时区偏差
  - 构建验证通过：`npm run build`
- Feature #68 (Step 5-6): 行为验证状态
  - 已尝试使用 Playwright 执行 Smart View 端到端验证（登录 + 视图切换 + 任务编辑触发出入视图）
  - 已绕过 MCP 持久会话限制，使用独立 Playwright（非持久上下文）完成补充验收
  - 验证通过（UI 编辑路径）：
    - 在 `Starred` 视图中通过任务行星标按钮取消星标，任务可在视图内自动消失（约 5-6 秒内）
    - 日期边界校验正确（本地日期 `2026-02-20`）：
      - `Overdue` 包含 `2026-02-19`
      - `Next 7 Days` 包含 `2026-02-20` 与 `2026-02-27`，不包含 `2026-02-28`
      - `No Date` 包含 `due_date/plan_date` 均为空的任务
  - 发现失败场景（已修复）：
    - 在 Smart View 打开状态下，若通过外部通道（API PATCH，模拟“其他设备/会话编辑”）修改任务字段，当前页面未触发自动出入视图
    - 复现：`Starred` 视图中将任务改为 `starred=false`，30 秒内仍停留；手动刷新页面后即消失
  - 修复：
    - `useRealtime` 改为稳定 Supabase client + handler ref，避免因组件重渲染导致 channel 频繁重建
    - `TaskPanel` 在 Smart View 模式新增可见页轮询兜底刷新（3 秒）+ `focus/visibilitychange` 触发即时刷新
  - 修复后验证：
    - 通过外部 API 将 `Starred` 任务改为 `starred=false` 后，任务约 1.5 秒内从当前视图消失（无需手动刷新）
  - Step 6 补充验证（本地跨天）：
    - 使用独立 Playwright 脚本将浏览器本地时间模拟到 `2026-02-20 23:59:59`
    - 临时禁用 Smart View 3 秒轮询（仅保留午夜 `setTimeout`）后，在 `Overdue` 视图观测到跨天后自动触发一次数据刷新请求（`/dashboard`），验证午夜刷新定时器生效
    - 日期视图动态校验：外部 API 修改日期后，`Overdue` 约 1.0 秒自动纳入任务，`Next 7 Days` 约 3.0 秒自动纳入任务
  - 结论：Feature #68 Step 5-6 验证完成，`feature_list.json` 已更新为 `passes: true`

#### 下一步
- Feature #69: Add reminders and notifications for plan/due dates

---

### 2026-02-19

#### 完成
- Feature #66 (Step 1): Inbox 快速收集入口
  - 在侧边栏新增 Inbox 智能入口（桌面端/移动端 Sheet 均支持）
  - 在 `dashboard-content.tsx` 新增 Inbox 视图状态，支持与 Today/Group/List 互斥切换
  - 支持 Inbox 视图下按 `N` 快捷键直接触发新建任务
  - 新增 `getOrCreateInboxList` server action：首次进入 Inbox 时自动创建并返回可用 Inbox 列表
  - 若用户尚无分组，会自动创建默认 `Inbox` 分组承载 Inbox 列表
  - 新增中英文文案：`sidebar.inbox`
  - 构建验证通过：`npm run build`
  - 说明：全量 `npm run lint` 当前仍有历史遗留错误（非本次改动引入）
- Feature #66 (Step 3): Inbox 专用任务 CRUD（Server Action + API）
  - 新增 `src/lib/inbox.ts`，统一封装 `getOrCreateInboxListForUser` 逻辑
  - 重构 `src/actions/lists.ts`：复用 `lib/inbox`，避免 Inbox 创建逻辑重复
  - 新增 `src/actions/tasks.ts` Inbox 专用 action：
    - `getInboxTasksWithSubtasks`
    - `createInboxTask`
    - `updateInboxTask`
    - `deleteInboxTask`
  - 新增 Inbox API 端点：
    - `GET/POST /api/v1/tasks/inbox`
    - `GET/PATCH/DELETE /api/v1/tasks/inbox/{id}`
  - 更新 OpenAPI 文档，新增 Inbox tasks 路径定义
- Feature #66 (Step 4): Inbox 任务一键移动到目标列表
  - 新增 `moveInboxTaskToList` server action（`src/actions/tasks.ts`）
  - 增加移动校验：仅允许移动 Inbox 顶层任务、目标列表必须属于当前用户且不能是 Inbox
  - 移动时保留子任务树关系：整棵子树同步更新到目标列表，根任务在目标列表追加到末尾
  - `TaskPanel` 在 Inbox 模式新增 `Move to...` 菜单，按分组/列表展示可选目标
  - 移动后自动刷新 Inbox 数据，任务即时从 Inbox 消失
- Feature #66 (Step 5-6): 桌面/移动端与移动流程验证
  - 桌面端验证：Inbox 新建任务成功，刷新后数据仍在
  - 桌面端验证：任务从 Inbox 移动到目标列表后，Inbox 消失且目标列表可见
  - 移动端视口验证：Inbox 任务创建后刷新仍可见（持久化正常）
  - 构建验证通过：`npm run build`
- Feature #67 (Step 1): 为任务模型添加 recurrence 字段
  - `supabase/schema.sql`：为 `tasks` 新增 `recurrence_frequency / recurrence_interval / recurrence_weekdays / recurrence_end_date / recurrence_end_count / recurrence_rule / recurrence_timezone / recurrence_source_task_id`
  - 同步补充 `ALTER TABLE ... ADD COLUMN IF NOT EXISTS`，兼容已有数据库
  - `src/lib/supabase/database.types.ts`：同步 Row/Insert/Update 类型
  - 新增 `src/lib/recurrence.ts`：统一解析与校验 recurrence 请求字段
  - `src/app/api/v1/tasks*` 与 `src/app/api/v1/tasks/inbox*`：POST/PATCH 接入 recurrence 字段写入与更新
  - `src/app/api/v1/search/tasks/route.ts`：补充搜索结果类型中的 recurrence 字段
  - `src/actions/tasks.ts`：扩展 Task/TaskUpdatePayload 的 recurrence 字段
  - `src/app/api/openapi/route.ts`：更新 Task schema 与任务创建/更新请求体文档
  - 构建验证通过：`npm run build`
- Feature #67 (Step 2): 任务详情支持配置重复规则
  - 新增 `src/components/dashboard/recurrence-fields.tsx`，统一渲染重复设置 UI
  - 详情面板支持设置：
    - 频率（不重复/每天/每周/每月/自定义）
    - 间隔（interval）
    - 每周重复日（weekly/custom）
    - 结束条件（永不结束/结束日期/重复次数）
    - 时区（timezone）与自定义 RRULE（custom）
  - `TaskDetailPanel` 与 `TaskDetailSheet` 同步接入，桌面端/移动端行为一致
  - 保存时将 recurrence 字段写入 `updateTask` payload，取消重复时回写为 `null`
  - 新增中英文文案：`src/messages/en.json`、`src/messages/zh.json`
  - 构建验证通过：`npm run build`
- Feature #67 (Step 3-4): 完成任务时按重复规则生成下一次，并保持 series linkage
  - 新增 `src/lib/recurrence-runtime.ts` 统一处理 recurring runtime：
    - 识别 `completed: false -> true` 状态跃迁并按需生成下一次 occurrence
    - 支持 `daily / weekly / monthly / custom(RRULE 子集)` 计算下一日期
    - 支持 `recurrence_end_date / recurrence_end_count` 截止条件
    - 自动维护 `recurrence_source_task_id`（首个 occurrence 自链接，后续 occurrence 统一指向 series root）
    - 避免重复生成（已存在未来 occurrence 时不重复创建）
  - `src/actions/tasks.ts` 的 `updateTask/updateInboxTask` 改为复用该 runtime
  - `src/app/api/v1/tasks/[id]/route.ts` 与 `src/app/api/v1/tasks/inbox/[id]/route.ts` PATCH 也复用同一逻辑，App 与 API 行为一致
- Feature #67 (Step 5): 时区边界与日期推进逻辑
  - recurrence runtime 采用 timezone-aware 的“今日”解析（`Intl.DateTimeFormat(..., { timeZone })`）作为无锚点任务的推进基准
  - 周重复计算基于日期字符串与 UTC 日历运算，规避本地时区解析偏移导致的跨日错误
  - `custom` 规则支持解析 `FREQ/INTERVAL/BYDAY/UNTIL/COUNT`，并与字段截止条件协同
- Feature #67 (Step 6): 编辑重复规则作用范围（single/future）
  - 任务详情 recurrence UI 新增作用范围选择：
    - `This occurrence only` / `This and future occurrences`
    - 中文：`仅当前任务` / `当前及未来任务`
  - 新增请求字段 `recurrence_update_scope`（`single | future`）
  - 当 scope=`future` 时，仅 recurrence 字段会批量应用到同 series 的当前及未来 occurrence，非 recurrence 字段仍只更新当前任务
  - OpenAPI 文档同步：PATCH task/inbox task 请求体新增 `recurrence_update_scope`
  - 构建验证通过：`npm run build`

#### 下一步
- Feature #68: Create smart views (Starred, Overdue, Next 7 Days, No Date)

---

### 2026-02-17

#### 完成
- Bug Fix: 窄屏幕点击任务时中间内容区白屏问题
  - 问题原因：移动端选中任务时，main 元素被 `hidden` 隐藏，但详情是通过 Sheet 叠加层显示的
  - 修复：移除移动端隐藏中间内容区的逻辑，让 Sheet 叠加在上面显示
  - 修改文件：src/app/dashboard/dashboard-content.tsx
  - 测试通过：窄屏幕点击任务，任务列表保持可见，详情 Sheet 正确显示

- Feature #65: Polish three-column layout styling and interactions
  - 添加平滑过渡动画 (transition-all duration-300 ease-in-out)
  - 详情面板打开/关闭时的宽度和透明度动画
  - 视觉分隔符 (border-l) 已存在于详情面板
  - 空状态提示 "No Task Selected" 已存在
  - Escape 键快捷键已存在并正常工作
  - 每列独立滚动 (overflow-y-auto)
  - 测试通过：平滑动画、键盘导航、深色模式

- Feature #64: Three-column layout
  - 创建 src/components/dashboard/task-detail-panel.tsx - 固定右侧面板组件
  - 更新 src/actions/tasks.ts - 添加 getTaskById 函数
  - 更新 src/components/dashboard/task-panel.tsx - 添加 selectedTaskId 和 onTaskSelect props
  - 更新 src/components/dashboard/task-detail-sheet.tsx - 支持 taskId prop 从 ID 加载任务
  - 重构 src/app/dashboard/dashboard-content.tsx - 实现三栏布局
  - 桌面端：侧边栏 (w-64) + 主内容区 (flex-1) + 详情面板 (w-96)
  - 移动端：点击任务时显示 Sheet 叠加层
  - Escape 键关闭详情面板
  - 测试通过：三栏布局、任务选择、编辑保存、关闭面板、移动端响应式

#### 下一步
- 所有已规划功能已完成

---

### 2026-02-16 (continued)

#### 完成
- Feature #57: API Documentation
  - 创建 src/app/api/openapi/route.ts - OpenAPI 3.0 规范 (18 个端点)
  - 创建 src/app/api-docs/page.tsx - Swagger UI 页面
  - 文档包含所有端点的请求/响应 schema
  - 支持 Bearer token 认证说明
  - 测试通过：GET /api/openapi 返回有效 JSON，/api-docs 渲染 Swagger UI

#### 下一步
- REST API 模块完成

---

#### 完成
- Feature #56: Search API
  - 创建 src/app/api/v1/search/tasks/route.ts - GET 搜索任务
  - 支持参数：?q= (查询)、?page= (页码)、?limit= (每页数量)
  - 响应格式：{ data: [], total, page, limit, total_pages }
  - 返回结果包含 list_name, list_icon, group_name, group_color
  - 测试通过：搜索、分页、空结果、无效参数验证

---

#### 完成
- Feature #55: Tasks CRUD API
  - 创建 src/app/api/v1/tasks/route.ts - GET (支持 ?list_id, ?completed, ?starred, ?parent_id 筛选) + POST
  - 创建 src/app/api/v1/tasks/[id]/route.ts - GET (含递归子任务) + PATCH + DELETE
  - 创建 src/app/api/v1/tasks/reorder/route.ts - PATCH (重排序)
  - 创建 src/app/api/v1/tasks/today/route.ts - GET (获取今日计划任务)
  - 创建 src/app/api/v1/tasks/starred/route.ts - GET (获取星标任务)
  - 测试通过：所有 CRUD 操作、子任务、筛选、重排序功能

---

#### 完成
- Feature #54: Lists CRUD API
  - 创建 src/app/api/v1/lists/route.ts - GET (支持 ?group_id 筛选) + POST (创建)
  - 创建 src/app/api/v1/lists/[id]/route.ts - GET + PATCH + DELETE
  - 创建 src/app/api/v1/lists/[id]/move/route.ts - PATCH (移动到其他分组)
  - 创建 src/app/api/v1/lists/reorder/route.ts - PATCH (组内重排序)
  - 测试通过：所有 CRUD 操作、移动、重排序功能

---

#### 完成
- Feature #53: Groups CRUD API
  - 更新 src/lib/api/auth.ts - 添加 getAuthenticatedUser 函数返回带用户 token 的 Supabase client
  - 创建 src/app/api/v1/groups/route.ts - GET (获取所有分组) + POST (创建分组)
  - 创建 src/app/api/v1/groups/[id]/route.ts - GET (获取单个) + PATCH (更新) + DELETE (删除)
  - 创建 src/app/api/v1/groups/reorder/route.ts - PATCH (重排序)
  - 测试通过：所有 CRUD 操作和重排序功能

---

#### 完成
- Feature #51: REST API 基础架构
  - 创建 src/lib/api/auth.ts - JWT token 验证函数 (verifyToken)
  - 创建 src/lib/api/response.ts - API 响应帮助函数 (successResponse, errorResponse, etc.)
  - 创建 src/middleware.ts - Next.js middleware 处理 /api/v1/* 路由认证
  - 创建 src/app/api/v1/auth/route.ts - CORS preflight 处理
  - 测试通过：CORS preflight、无 token 返回 401
- Feature #52: Auth API endpoints
  - /api/v1/auth/login - POST 登录获取 token
  - /api/v1/auth/register - POST 注册新用户
  - /api/v1/auth/refresh - POST 刷新 token
  - /api/v1/auth/logout - POST 登出
  - /api/v1/auth/me - GET 获取当前用户信息
  - 测试通过：登录返回 token，/me 无 token 返回 401，有 token 返回用户信息

---

#### 完成
- REST API 规划：为多平台客户端（iOS/Android/HarmonyOS/macOS/Windows/Linux）规划REST API
  - 分析现有代码：项目目前只有Server Actions，没有对外REST API
  - 在 feature_list.json 中添加 Feature #51-57 (REST API)
  - 将每个feature的steps拆解为详细的子步骤，每步包含具体操作和测试方法

#### 下一步
- 开始实现 Feature #51: REST API 基础架构

---

#### 完成
- Feature #47-50: i18n 国际化功能
  - 安装 next-intl 包（但最终使用 React Context 方案）
  - 创建 src/i18n/index.tsx 国际化上下文和 hook
  - 创建 src/messages/en.json 英文翻译
  - 创建 src/messages/zh.json 中文翻译
  - 创建 src/components/language-switcher.tsx 语言切换器
  - 更新 Sidebar、ListPanel、TaskPanel、TaskDetailSheet 组件使用翻译
  - 语言偏好保存在 localStorage
  - 测试通过：语言切换、刷新页面持久化
- Feature #18: List UI - 显示列表
  - 创建 src/actions/lists.ts server action（getLists, createList, updateList, deleteList, reorderLists, moveListToGroup）
  - 创建 src/components/dashboard/list-panel.tsx 列表面板组件
  - 更新 Sidebar 组件支持分组选择（selectedGroupId, onGroupSelect）
  - 重构 Dashboard 页面，分离 DashboardContent 客户端组件
  - 列表显示名称和 emoji 图标
  - 修复分组切换后列表不更新的问题（改进点击事件处理）
- Feature #19: List Create - 创建列表
  - 已在 ListPanel 中实现创建对话框
  - 支持名称和 12 种 emoji 图标选择
  - 测试通过
- Feature #17.5: Sidebar Tree - 侧边栏树形结构
  - 重构 Sidebar 组件支持在分组下方显示子列表
  - 添加展开/收起功能（ChevronRight/ChevronDown 图标）
  - 显示列表数量徽章
  - 点击列表更新主区域标题
  - 点击分组菜单可添加列表
  - 测试通过
- Feature #20: List Edit - 编辑列表
  - 编辑对话框已存在于 ListPanel
  - 支持修改名称和图标
  - 测试通过
- Feature #21: List Delete - 删除列表
  - 删除确认对话框已存在于 ListPanel
  - 显示删除警告（会删除关联任务）
  - 测试通过
- Feature #22: List Sort - 拖拽排序列表
  - 使用 @dnd-kit 在 ListPanel 中添加拖拽排序功能
  - 创建 SortableListItem 组件处理单个可排序列表项
  - 添加 GripVertical 拖拽手柄，hover 时显示
  - 使用 reorderLists server action 批量更新 sort_order
  - 测试通过：拖拽排序后刷新页面顺序持久化
- Feature #23: List Move - 移动列表到其他分组
  - 在 ListPanel 中添加移动对话框
  - 显示可选的目标分组列表（排除当前分组）
  - 使用 moveListToGroup server action 更新 group_id
  - 添加 FolderInput 图标到 Move 菜单项
  - 测试通过：列表成功移动到其他分组并持久化
- 侧边栏列表拖拽排序
  - 添加 SortableSidebarListItem 组件
  - 在每个分组内添加独立的 DndContext 处理列表排序
  - 侧边栏和主面板列表排序同步更新
  - 测试通过
- Feature #24: Task UI - 显示任务
  - 创建 src/actions/tasks.ts server action（getTasks, createTask, updateTask, deleteTask, reorderTasks）
  - 创建 src/components/dashboard/task-panel.tsx 任务面板组件
  - 安装 shadcn/ui Checkbox 组件
  - 更新 dashboard-content.tsx 根据 selectedListId 显示任务面板
  - 测试通过
- Feature #25: Task Create - 创建任务
  - TaskPanel 中添加内联输入创建任务
  - 支持 Enter 快捷键提交
  - 测试通过
- Feature #26: Task Complete - 标记完成
  - 使用 Checkbox 组件切换完成状态
  - 完成任务显示删除线样式
  - 测试通过
- Feature #30: Task Star - 星标任务
  - 点击星标图标切换 starred 状态
  - 测试通过
- Feature #27: Task Edit - 编辑任务名称
  - 添加 SortableTaskItem 组件支持内联编辑
  - 点击 Edit 菜单项进入编辑模式
  - Enter 保存，Escape 取消
  - 测试通过
- Feature #28: Task Delete - 删除任务
  - 添加删除确认对话框
  - 点击 Delete 确认后删除任务
  - 测试通过
- Feature #29: Task Sort - 拖拽排序任务
  - 使用 @dnd-kit 添加拖拽排序功能
  - 添加 GripVertical 拖拽手柄
  - 调用 reorderTasks server action 持久化排序
  - 测试通过：拖拽排序后刷新页面顺序持久化
- Feature #31: Task Detail Panel - 任务详情面板
  - 创建 src/components/dashboard/task-detail-sheet.tsx 组件
  - 安装 shadcn/ui popover, calendar, sheet, textarea 组件
  - 点击任务名称打开右侧滑出详情面板
  - 详情面板支持编辑所有任务属性
  - 测试通过
- Feature #32: Task Due Date - 设置截止日期
  - 使用 Calendar 组件选择日期
  - 支持 Clear 按钮清除日期
  - 日期格式化显示 (format from date-fns)
  - 测试通过
- Feature #33: Task Plan Date - 设置计划日期
  - 与 Due Date 相同的日期选择器实现
  - 测试通过
- Feature #34: Task Comment - 添加备注
  - 使用 Textarea 组件
  - 支持多行文本输入
  - 测试通过
- Feature #35: Task Duration - 设置时长
  - 使用 Input type="number" 组件
  - 以分钟为单位
  - 测试通过
- Feature #36: Task Subtask - 创建子任务
  - 更新 src/actions/tasks.ts 添加 getTasksWithSubtasks 函数（递归获取嵌套子任务）
  - 更新 Task 类型添加 subtasks 可选字段
  - 重构 TaskPanel 组件支持递归渲染嵌套任务
  - 添加 TaskItem 组件处理单个可排序任务项（支持展开/收起子任务）
  - 添加 ChevronRight/ChevronDown 图标用于展开/收起
  - 添加 "Add Subtask" 菜单项
  - 子任务可独立完成
  - 测试通过
- Feature #37: Task Nested Subtask - 无限嵌套子任务
  - 递归渲染支持无限层级
  - 使用 level 参数控制缩进
  - 每层子任务有独立的展开/收起功能
  - 测试通过 3 层嵌套
  - 刷新后数据持久化正常
- Feature #38: Light/dark theme toggle support - 主题切换
  - 安装 next-themes 包
  - 创建 src/components/theme-provider.tsx 主题提供者组件
  - 创建 src/components/theme-toggle.tsx 主题切换按钮组件
  - 更新 layout.tsx 添加 ThemeProvider 和 suppressHydrationWarning
  - 在 Sidebar header 添加主题切换按钮
  - 支持 Light、Dark、System 三种模式
  - 主题持久化到 localStorage
  - 测试通过：切换主题、刷新页面持久化、切换回原主题
- Feature #39: Responsive layout for mobile devices - 移动端响应式布局
  - 更新 dashboard-content.tsx 添加响应式布局
  - 使用 Sheet 组件实现移动端侧边栏滑出菜单
  - 桌面端显示固定侧边栏，移动端隐藏
  - 添加汉堡菜单按钮（Menu 图标）仅在移动端显示
  - 点击菜单项自动关闭移动端侧边栏
  - 调整主内容区 padding 适配移动端
  - 测试通过：移动端汉堡菜单、侧边栏滑出、点击导航、桌面端布局
- Feature #40: Keyboard shortcuts for common operations - 键盘快捷键
  - 创建 src/hooks/use-keyboard-shortcuts.ts 自定义 Hook
  - 创建 src/components/keyboard-shortcuts-dialog.tsx 快捷键帮助对话框
  - 更新 ListPanel 和 TaskPanel 使用 forwardRef 暴露创建方法
  - 更新 dashboard-content.tsx 集成键盘快捷键
  - 支持 N（新建任务/列表）、L（新建列表）、?（显示帮助）、Esc（关闭对话框）
  - 快捷键在输入框中自动禁用
  - 在 header 添加快捷键帮助按钮
  - 测试通过：? 显示帮助、Esc 关闭对话框、N 创建任务/列表
- Feature #41: Loading states with skeleton screens - 骨架屏加载状态
  - 安装 shadcn/ui skeleton 组件
  - 创建 src/components/dashboard/skeletons.tsx 骨架屏组件
  - 创建 SidebarSkeleton、ListPanelSkeleton、TaskPanelSkeleton 组件
  - 创建 src/app/dashboard/loading.tsx 页面加载骨架屏
  - 更新 TaskPanel 添加 isLoadingTasks 状态，加载时显示骨架屏
  - 测试通过：页面加载和任务列表切换时骨架屏显示
- Feature #42: Empty state prompts when no data exists - 空状态提示
  - 已在先前功能中实现，验证测试通过
  - Sidebar: "No groups yet" + "Create your first group" 按钮
  - ListPanel: "No lists in this group yet" + "Create your first list" 按钮
  - TaskPanel: "No tasks in this list yet" + "Create your first task" 按钮
  - 测试通过：分组、列表、任务的空状态均正确显示
- Feature #43: Global search across all tasks - 全局搜索
  - 添加 searchTasks server action 在 src/actions/tasks.ts
  - 创建 src/components/search-dialog.tsx 搜索对话框组件
  - 支持 Ctrl/Cmd+K 快捷键打开搜索
  - 搜索结果显示任务名称、状态、星标、截止日期、所属列表和分组
  - 点击结果导航到对应列表
  - 更新键盘快捷键帮助文档
  - 测试通过：搜索、点击结果导航
- Feature #44: Filter tasks by status, date, star - 任务筛选
  - 在 TaskPanel 添加筛选下拉菜单
  - 支持按状态筛选（All/Completed/Incomplete）
  - 支持按星标筛选（All/Starred/Unstarred）
  - 支持按日期筛选（All/Overdue/Today/Upcoming/No Due Date）
  - 支持组合筛选
  - 显示筛选后的任务数量（如 "0 of 3 tasks"）
  - 空状态提示"No tasks match your filters"和清除筛选按钮
  - 测试通过：Completed 筛选、Clear Filters
- Feature #45: Today view showing tasks with plan_date = today - 今日视图
  - 添加 getTodayTasks server action 在 src/actions/tasks.ts
  - 创建 src/components/dashboard/today-panel.tsx 今日面板组件
  - 在 Sidebar 添加 "Today" 快捷入口（太阳图标）
  - 显示今天的日期和计划任务
  - 任务按列表分组显示
  - 空状态提示设置 plan_date 的说明
  - 测试通过：Today 视图导航、日期显示
- Feature #46: Realtime sync across multiple devices - 实时同步
  - 创建 src/hooks/use-realtime.ts 自定义 Hook
  - 订阅 Supabase Postgres Changes
  - TaskPanel 订阅任务表变化
  - DashboardContent 订阅分组和列表表变化
  - TodayPanel 订阅任务表变化
  - 测试通过：两个浏览器标签同步任务创建

---

### 2026-02-15

### 2026-02-15

#### 完成
- 重构 feature_list.json：从 phase 嵌套结构改为扁平数字编号 (1-52)
- 为每个 feature 添加 steps 字段，指导 Playwright 测试步骤
- 更新 claude-progress.txt 适配新格式
- Feature #16: Group Sort - 拖拽排序分组
  - 安装 @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities
  - 添加 reorderGroups server action 批量更新 sort_order
  - 更新 Sidebar 组件支持拖拽排序（SortableGroupItem 组件）
  - 添加 GripVertical 拖拽手柄，hover 时显示
- Feature #18: List UI - 显示列表
  - 创建 src/actions/lists.ts server action（getLists, createList, updateList, deleteList, reorderLists, moveListToGroup）
  - 创建 src/components/dashboard/list-panel.tsx 列表面板组件
  - 更新 Sidebar 组件支持分组选择（selectedGroupId, onGroupSelect）
  - 重构 Dashboard 页面，分离 DashboardContent 客户端组件
  - 列表显示名称和 emoji 图标

#### 下一步
- **Feature #17.5: Sidebar Tree - 侧边栏树形结构显示列表（新增）**
- 实现 Feature #19: List Create - 创建列表（已在测试中实现）
- 实现 Feature #20: List Edit - 编辑列表（已在测试中实现）
- 实现 Feature #21: List Delete - 删除列表（已在测试中实现）
- 继续实现 Feature #22-23: List Sort/Move

---

### 2026-02-14

#### 完成
- Feature #12: Group List UI - 侧边栏显示分组列表
- Feature #13: Group Create - 创建分组（名称+颜色选择器）
- Feature #14: Group Edit - 编辑分组名称和颜色
- Feature #15: Group Delete - 删除分组（带确认对话框）
- Feature #17: Group Sidebar - 左侧固定侧边栏布局

#### 下一步
- 实现 Feature #16: Group Sort 或继续 List Module

---

### 2026-02-13

#### 完成
- Feature #6-11: 完整认证系统
  - #6: 登录页面 UI
  - #7: 用户注册
  - #8: 用户登录
  - #9: 用户登出
  - #10: Session 持久化
  - #11: 路由保护

#### 下一步
- Group Module 功能实现

---

### 2026-02-12

#### 完成
- Feature #1-5: 项目初始化
  - #1: Next.js 项目脚手架
  - #2: shadcn/ui 安装配置
  - #3: Supabase 项目创建
  - #4: 数据库 Schema
  - #5: Supabase Client 配置

#### 下一步
- 认证系统实现

---

## Notes
- Using Tailwind CSS v4 (latest)
- Next.js 16.1.6 with App Router
- shadcn/ui with new-york style, neutral color scheme
- All features tested with Playwright MCP
